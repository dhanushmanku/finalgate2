<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gatekeeper Dashboard - Gate Pass System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/48/000000/security-pass.png">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/dist/html5-qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="logout-btn" onclick="logout()">Logout</button>
            <h1>Gatekeeper Dashboard</h1>
            <p id="welcome-text">Welcome</p>
        </div>

        <div class="card">
            <h3>Scan Gate Pass</h3>
            <div class="scanner-container">
                <p style="margin-bottom: 20px; color: #666;">Enter the Pass ID from QR Code</p>
                <input type="text" id="scanner-input" placeholder="Paste or type Pass ID here" autofocus>
                <button onclick="scanPass()" class="btn btn-scan">Verify Pass</button>
                <button id="open-scanner" onclick="openScanner()" class="btn" style="margin-left:10px;"><i class="fas fa-qrcode"></i> Open Scanner</button>
                
                <div id="scan-result" style="display: none; margin-top: 30px;">
                    <div class="pass-details">
                        <h4>Pass Details</h4>
                        <p><strong>Student Name:</strong> <span id="pass-student"></span></p>
                        <p><strong>Reason:</strong> <span id="pass-reason"></span></p>
                        <p><strong>Requested At:</strong> <span id="pass-requested"></span></p>
                        <p><strong>Approved At:</strong> <span id="pass-approved"></span></p>
                        <p><strong>Status:</strong> <span id="pass-status"></span></p>
                        <p><strong>Moderator Remarks:</strong> <span id="pass-remarks"></span></p>
                        
                        <div id="action-buttons" style="margin-top: 20px; display: none;">
                            <button onclick="markAsUsed()" class="btn-primary">Mark as Used & Allow Exit</button>
                        </div>
                        
                        <div id="error-status" style="display: none; background: #ffe6e6; padding: 15px; border-radius: 8px; margin-top: 15px; color: #8f191d;">
                        </div>
                        
                        <div id="success-status" style="display: none; background: #e6ffe6; padding: 15px; border-radius: 8px; margin-top: 15px; color: #03505d;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- QR scanner modal -->
    <div id="html5-qrcode-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000;">
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:12px; text-align:center;">
            <div id="html5-qrcode-region" style="width:320px; height:320px; margin:0 auto;"></div>
            <div style="margin-top:12px;">
                <button onclick="closeScanner()" class="btn">Close Scanner</button>
            </div>
        </div>
    </div>

        <div class="card">
            <h3>Recent Exit History</h3>
            <div class="table-container">
                <table id="history-table">
                    <thead>
                        <tr>
                            <th>Exit Time</th>
                            <th>Student Name</th>
                            <th>Reason</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="history-body">
                        <tr>
                            <td colspan="4" style="text-align: center;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        const API_URL = 'http://localhost:3000';
        let currentUser = null;
        let currentPassId = null;

        function checkAuth() {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = 'login.html';
                return null;
            }
            currentUser = JSON.parse(userStr);
            if (currentUser.role !== 'gatekeeper') {
                window.location.href = 'login.html';
                return null;
            }
            document.getElementById('welcome-text').textContent = `Welcome, ${currentUser.name}`;
            return currentUser;
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        document.getElementById('scanner-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                scanPass();
            }
        });

        async function scanPass() {
            const passId = document.getElementById('scanner-input').value.trim();
            
            if (!passId) {
                alert('Please enter a Pass ID');
                return;
            }
            
            currentPassId = passId;
            
            try {
                const response = await fetch(`${API_URL}/api/passes/${passId}`);
                const data = await response.json();
                
                const resultDiv = document.getElementById('scan-result');
                const actionButtons = document.getElementById('action-buttons');
                const errorStatus = document.getElementById('error-status');
                const successStatus = document.getElementById('success-status');
                
                errorStatus.style.display = 'none';
                successStatus.style.display = 'none';
                actionButtons.style.display = 'none';
                
                if (data.success) {
                    const pass = data.pass;
                    
                    document.getElementById('pass-student').textContent = pass.studentName;
                    document.getElementById('pass-reason').textContent = pass.reason;
                    document.getElementById('pass-requested').textContent = new Date(pass.requestedAt).toLocaleString();
                    document.getElementById('pass-approved').textContent = pass.approvedAt ? new Date(pass.approvedAt).toLocaleString() : '-';
                    document.getElementById('pass-remarks').textContent = pass.moderatorRemarks || '-';
                    
                    const statusSpan = document.getElementById('pass-status');
                    statusSpan.className = `status ${pass.status}`;
                    statusSpan.textContent = pass.status.toUpperCase();
                    
                    resultDiv.style.display = 'block';
                    
                    if (pass.status === 'approved' && !pass.usedAt) {
                        actionButtons.style.display = 'block';
                        successStatus.textContent = '✓ Pass is valid! Click button below to mark as used.';
                        successStatus.style.display = 'block';
                    } else if (pass.status === 'pending') {
                        errorStatus.textContent = '⚠ This pass is still pending approval from moderator.';
                        errorStatus.style.display = 'block';
                    } else if (pass.status === 'rejected') {
                        errorStatus.textContent = '✗ This pass has been rejected. Student cannot exit.';
                        errorStatus.style.display = 'block';
                    } else if (pass.usedAt) {
                        errorStatus.textContent = '⚠ This pass has already been used on ' + new Date(pass.usedAt).toLocaleString();
                        errorStatus.style.display = 'block';
                    }
                } else {
                    alert('Pass not found! Please check the Pass ID.');
                }
            } catch (error) {
                alert('Error scanning pass. Please try again.');
            }
        }

        async function markAsUsed() {
            if (!currentPassId) return;
            
            try {
                const response = await fetch(`${API_URL}/api/passes/${currentPassId}/use`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const successStatus = document.getElementById('success-status');
                    successStatus.textContent = '✓ Pass marked as used! Student can exit now.';
                    successStatus.style.display = 'block';
                    
                    document.getElementById('action-buttons').style.display = 'none';
                    document.getElementById('scanner-input').value = '';
                    
                    loadHistory();
                    
                    setTimeout(() => {
                        document.getElementById('scan-result').style.display = 'none';
                    }, 3000);
                } else {
                    alert(data.message || 'Error marking pass as used');
                }
            } catch (error) {
                alert('Error updating pass. Please try again.');
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch(`${API_URL}/api/passes`);
                const data = await response.json();
                
                if (data.success) {
                    const usedPasses = data.passes.filter(p => p.usedAt).sort((a, b) => 
                        new Date(b.usedAt) - new Date(a.usedAt)
                    ).slice(0, 10);
                    
                    const historyBody = document.getElementById('history-body');
                    
                    if (usedPasses.length > 0) {
                        historyBody.innerHTML = usedPasses.map(pass => `
                            <tr>
                                <td>${new Date(pass.usedAt).toLocaleString()}</td>
                                <td>${pass.studentName}</td>
                                <td>${pass.reason}</td>
                                <td><span class="status ${pass.status}">USED</span></td>
                            </tr>
                        `).join('');
                    } else {
                        historyBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No exit history yet</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        // Run safely after DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Ensure user is authenticated and has gatekeeper role
                const user = APP.Auth.checkAuth(['gatekeeper']);
                if (!user) return;
                document.getElementById('welcome-text').textContent = `Welcome, ${user.name}`;

                let currentPassId = null;

                const scannerInput = document.getElementById('scanner-input');
                const scanResult = document.getElementById('scan-result');
                const actionButtons = document.getElementById('action-buttons');
                const errorStatus = document.getElementById('error-status');
                const successStatus = document.getElementById('success-status');

                scannerInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') scanPass();
                });

                // QR scanner (webcam) support using Html5Qrcode
                let html5QrcodeScanner = null;

                async function startScanner() {
                    const modal = document.getElementById('html5-qrcode-modal');
                    const regionId = 'html5-qrcode-region';
                    modal.style.display = 'block';

                    try {
                        html5QrcodeScanner = new Html5Qrcode(regionId);
                        const config = { fps: 10, qrbox: 250 };
                        await html5QrcodeScanner.start({ facingMode: 'environment' }, config,
                            (decodedText, decodedResult) => {
                                // on successful scan
                                scannerInput.value = decodedText;
                                stopScanner();
                                // auto-verify the scanned pass
                                scanPass();
                            },
                            (errorMessage) => {
                                // scanning in progress; ignore non-fatal errors
                            }
                        );
                    } catch (err) {
                        modal.style.display = 'none';
                        APP.Toast.show('Unable to start camera for QR scanner. Check permissions and camera availability.', 'error');
                        console.error('startScanner error:', err);
                    }
                }

                async function stopScanner() {
                    const modal = document.getElementById('html5-qrcode-modal');
                    try {
                        if (html5QrcodeScanner) {
                            await html5QrcodeScanner.stop();
                            await html5QrcodeScanner.clear();
                            html5QrcodeScanner = null;
                        }
                    } catch (err) {
                        console.warn('Error stopping scanner', err);
                    }
                    modal.style.display = 'none';
                }

                // expose open/close functions for inline handlers
                window.openScanner = startScanner;
                window.closeScanner = stopScanner;

                async function scanPass() {
                    const passId = scannerInput.value.trim();
                    if (!passId) {
                        APP.Toast.show('Please enter a Pass ID', 'error');
                        return;
                    }
                    currentPassId = passId;

                    try {
                        const data = await APP.ApiClient.request(`/api/passes/${passId}`);

                        errorStatus.style.display = 'none';
                        successStatus.style.display = 'none';
                        actionButtons.style.display = 'none';

                        const pass = data.pass;
                        document.getElementById('pass-student').textContent = pass.studentName;
                        document.getElementById('pass-reason').textContent = pass.reason;
                        document.getElementById('pass-requested').textContent = pass.requestedAt ? new Date(pass.requestedAt).toLocaleString() : '-';
                        document.getElementById('pass-approved').textContent = pass.approvedAt ? new Date(pass.approvedAt).toLocaleString() : '-';
                        document.getElementById('pass-remarks').textContent = pass.moderatorRemarks || '-';

                        const statusSpan = document.getElementById('pass-status');
                        statusSpan.className = `status ${pass.status}`;
                        statusSpan.textContent = pass.status.toUpperCase();

                        scanResult.style.display = 'block';

                        if (pass.status === 'approved' && !pass.usedAt) {
                            actionButtons.style.display = 'block';
                            successStatus.textContent = '✓ Pass is valid! Click button below to mark as used.';
                            successStatus.style.display = 'block';
                        } else if (pass.status === 'pending') {
                            errorStatus.textContent = '⚠ This pass is still pending approval from moderator.';
                            errorStatus.style.display = 'block';
                        } else if (pass.status === 'rejected') {
                            errorStatus.textContent = '✗ This pass has been rejected. Student cannot exit.';
                            errorStatus.style.display = 'block';
                        } else if (pass.usedAt) {
                            errorStatus.textContent = '⚠ This pass has already been used on ' + new Date(pass.usedAt).toLocaleString();
                            errorStatus.style.display = 'block';
                        }
                    } catch (err) {
                        // APP.ApiClient.request already shows toast on network errors
                    }
                }

                async function markAsUsed() {
                    if (!currentPassId) return;
                    try {
                        await APP.ApiClient.request(`/api/passes/${currentPassId}/use`, { method: 'PUT' });
                        successStatus.textContent = '✓ Pass marked as used! Student can exit now.';
                        successStatus.style.display = 'block';
                        actionButtons.style.display = 'none';
                        scannerInput.value = '';
                        loadHistory();
                        setTimeout(() => { scanResult.style.display = 'none'; }, 3000);
                    } catch (err) {
                        // handled by ApiClient
                    }
                }

                async function loadHistory() {
                    try {
                        const data = await APP.ApiClient.request('/api/passes');
                        const usedPasses = data.passes.filter(p => p.usedAt).sort((a, b) => new Date(b.usedAt) - new Date(a.usedAt)).slice(0, 10);
                        const historyBody = document.getElementById('history-body');
                        if (usedPasses.length > 0) {
                            historyBody.innerHTML = usedPasses.map(pass => `
                                <tr>
                                    <td>${pass.usedAt ? new Date(pass.usedAt).toLocaleString() : '-'}</td>
                                    <td>${pass.studentName}</td>
                                    <td>${pass.reason}</td>
                                    <td><span class="status ${pass.status}">USED</span></td>
                                </tr>
                            `).join('');
                        } else {
                            historyBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No exit history yet</td></tr>';
                        }
                    } catch (err) {
                        // handled by ApiClient
                    }
                }

                // expose functions to inline handlers
                window.scanPass = scanPass;
                window.markAsUsed = markAsUsed;

                loadHistory();
                setInterval(loadHistory, APP.config.AUTO_REFRESH_INTERVAL);
            } catch (e) {
                console.error('Gatekeeper init error:', e);
            }
        });
    </script>
</body>
</html>