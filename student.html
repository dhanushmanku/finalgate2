<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Gate Pass System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <button class="logout-btn" onclick="logout()">Logout</button>
                <div class="notification-bell" onclick="toggleNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notification-count">0</span>
                    <div class="notification-dropdown" id="notification-dropdown">
                        <div class="notification-item">
                            <div class="notification-title">New Pass Approved</div>
                            <div class="notification-message">Your gate pass request has been approved</div>
                            <div class="notification-time">2 minutes ago</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="header-center">
                <h1>Student Dashboard</h1>
                <p id="welcome-text">Welcome</p>
            </div>
        </div>

        <!-- Dashboard Analytics -->
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-id-card"></i>
                </div>
                <div class="stat-number" id="total-passes">0</div>
                <div class="stat-label">Total Passes</div>
                <div class="stat-change positive">+2 this week</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-number" id="approved-passes">0</div>
                <div class="stat-label">Approved</div>
                <div class="stat-change positive">85% success rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-number" id="pending-passes">0</div>
                <div class="stat-label">Pending</div>
                <div class="stat-change">Awaiting approval</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-calendar-week"></i>
                </div>
                <div class="stat-number" id="this-week">0</div>
                <div class="stat-label">This Week</div>
                <div class="stat-change positive">Active requests</div>
            </div>
        </div>

        <!-- Profile Section -->
        <div class="profile-section">
            <div class="profile-header">
                <div class="profile-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="profile-info">
                    <h3 id="profile-name">Student Name</h3>
                    <p id="profile-role">Student ID: -</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Request New Gate Pass</h3>
            <div id="success-message" class="success-message"></div>
            <div id="error-message" class="error-message"></div>
            
            <form id="pass-form">
                <div class="form-group">
                    <label>Pass Category</label>
                    <div class="category-tags">
                        <span class="category-tag active" data-category="medical">üè• Medical</span>
                        <span class="category-tag" data-category="home">üè† Home Visit</span>
                        <span class="category-tag" data-category="emergency">üö® Emergency</span>
                        <span class="category-tag" data-category="personal">üë§ Personal</span>
                        <span class="category-tag" data-category="academic">üìö Academic</span>
                        <span class="category-tag" data-category="other">üìù Other</span>
                    </div>
                    <input type="hidden" id="category" value="medical">
                </div>
                
                <div class="form-group">
                    <label>Reason for Exit</label>
                    <input type="text" id="reason" required placeholder="e.g., Medical appointment, Home visit">
                </div>
                
                <div class="form-group">
                    <label>Expected Return Time (Optional)</label>
                    <input type="datetime-local" id="return-time">
                </div>
                
                <div class="form-group">
                    <label>Additional Notes (Optional)</label>
                    <textarea id="notes" rows="3" placeholder="Any additional information..."></textarea>
                </div>
                
                <button type="submit" class="btn-primary">
                    <i class="fas fa-paper-plane"></i>
                    Submit Request
                </button>
            </form>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>My Pass Requests</h3>
                <div class="export-buttons">
                    <button class="export-btn" onclick="exportToCSV()">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                    <button class="export-btn" onclick="printPasses()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </div>
            
            <div class="bulk-actions" id="bulk-actions">
                <span>Bulk Actions:</span>
                <select id="bulk-action">
                    <option value="">Select Action</option>
                    <option value="cancel">Cancel Selected</option>
                </select>
                <button class="btn" onclick="executeBulkAction()">Apply</button>
                <button class="btn" onclick="clearSelection()">Clear</button>
            </div>
            
            <div class="table-container">
                <table id="passes-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Reason</th>
                            <th>Status</th>
                            <th>Remarks</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="passes-body">
                        <tr>
                            <td colspan="7" style="text-align: center;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="qr-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; max-width: 400px;">
            <h3 style="color: #8f191d; margin-bottom: 20px; text-align: center;">Your Gate Pass QR Code</h3>
            <div id="qrcode" class="qr-container"></div>
            <div id="qrcode-passid" style="text-align:center; margin-top:12px;">
                <small style="color:#666; display:block; margin-bottom:6px;">Pass ID</small>
                <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
                    <code id="pass-id-text" style="background:#f5f5f5; padding:6px 10px; border-radius:6px;">-</code>
                    <button id="copy-passid" class="btn" style="padding:6px 10px;" onclick="copyPassId()"><i class="fas fa-copy"></i></button>
                </div>
            </div>
            <p style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">Show this QR code at the gate or let the gatekeeper scan it</p>
            <button onclick="closeQRModal()" class="btn-primary" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000';
        let currentUser = null;

        // Check if user is logged in
        function checkAuth() {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = 'login.html';
                return null;
            }
            currentUser = JSON.parse(userStr);
            if (currentUser.role !== 'student') {
                window.location.href = 'login.html';
                return null;
            }
            document.getElementById('welcome-text').textContent = `Welcome, ${currentUser.name}`;
            document.getElementById('profile-name').textContent = currentUser.name;
            document.getElementById('profile-role').textContent = `Student ID: ${currentUser.id}`;
            return currentUser;
        }

        // Toggle notifications
        function toggleNotifications() {
            const dropdown = document.getElementById('notification-dropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        // Category selection
        document.addEventListener('DOMContentLoaded', function() {
            const categoryTags = document.querySelectorAll('.category-tag');
            const categoryInput = document.getElementById('category');
            
            categoryTags.forEach(tag => {
                tag.addEventListener('click', function() {
                    categoryTags.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    categoryInput.value = this.dataset.category;
                });
            });
        });

        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // Submit pass request
        document.getElementById('pass-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const reason = document.getElementById('reason').value;
            const category = document.getElementById('category').value;
            const returnTime = document.getElementById('return-time').value;
            const notes = document.getElementById('notes').value;
            const successDiv = document.getElementById('success-message');
            const errorDiv = document.getElementById('error-message');
            
            try {
                const response = await fetch(`${API_URL}/api/passes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        studentId: currentUser.id,
                        studentName: currentUser.name,
                        reason: reason,
                        category: category,
                        returnTime: returnTime,
                        notes: notes
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    successDiv.textContent = 'Pass request submitted successfully!';
                    successDiv.style.display = 'block';
                    errorDiv.style.display = 'none';
                    document.getElementById('reason').value = '';
                    document.getElementById('return-time').value = '';
                    document.getElementById('notes').value = '';
                    loadPasses();
                    updateDashboardStats();
                    
                    setTimeout(() => {
                        successDiv.style.display = 'none';
                    }, 3000);
                } else {
                    errorDiv.textContent = 'Failed to submit request';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Error connecting to server';
                errorDiv.style.display = 'block';
            }
        });

        // Load student's passes
        async function loadPasses() {
            try {
                const response = await fetch(`${API_URL}/api/passes/student/${currentUser.id}`);
                const data = await response.json();
                
                const tbody = document.getElementById('passes-body');
                
                if (data.success && data.passes.length > 0) {
                    tbody.innerHTML = data.passes.map(pass => `
                        <tr>
                            <td>${new Date(pass.requestedAt).toLocaleString()}</td>
                            <td>${pass.reason}</td>
                            <td><span class="status ${pass.status}">${pass.status.toUpperCase()}</span></td>
                            <td>${pass.moderatorRemarks || '-'}</td>
                            <td>
                                ${pass.status === 'approved' && !pass.usedAt ? 
                                    `<button class="btn btn-scan" onclick="showQRCode('${pass.id}')">Show QR</button>` : 
                                    pass.usedAt ? '<span style="color: #999;">Used</span>' : '-'
                                }
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No pass requests yet</td></tr>';
                }
            } catch (error) {
                console.error('Error loading passes:', error);
            }
        }

        function showQRCode(passId) {
            const qrDiv = document.getElementById('qrcode');
            qrDiv.innerHTML = '';
            
            new QRCode(qrDiv, {
                text: passId,
                width: 256,
                height: 256,
                colorDark: '#03505d',
                colorLight: '#ffffff'
            });
            
                // show pass id below QR
                const passIdText = document.getElementById('pass-id-text');
                if (passIdText) passIdText.textContent = passId;

                document.getElementById('qr-modal').style.display = 'block';
        }

            function copyPassId() {
                const passIdText = document.getElementById('pass-id-text');
                if (!passIdText) return;
                const text = passIdText.textContent || '';
                navigator.clipboard?.writeText(text).then(() => {
                    alert('Pass ID copied to clipboard');
                }).catch(() => {
                    alert('Unable to copy. Please select and copy manually.');
                });
            }

        function closeQRModal() {
            document.getElementById('qr-modal').style.display = 'none';
        }

        // Update dashboard statistics
        async function updateDashboardStats() {
            try {
                const response = await fetch(`${API_URL}/api/passes/student/${currentUser.id}`);
                const data = await response.json();
                
                if (data.success) {
                    const passes = data.passes;
                    const total = passes.length;
                    const approved = passes.filter(p => p.status === 'approved').length;
                    const pending = passes.filter(p => p.status === 'pending').length;
                    
                    // This week calculation
                    const oneWeekAgo = new Date();
                    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                    const thisWeek = passes.filter(p => new Date(p.requestedAt) >= oneWeekAgo).length;
                    
                    document.getElementById('total-passes').textContent = total;
                    document.getElementById('approved-passes').textContent = approved;
                    document.getElementById('pending-passes').textContent = pending;
                    document.getElementById('this-week').textContent = thisWeek;
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Export to CSV
        function exportToCSV() {
            const table = document.getElementById('passes-table');
            const rows = Array.from(table.querySelectorAll('tr'));
            const csvContent = rows.map(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                return cells.map(cell => `"${cell.textContent.trim()}"`).join(',');
            }).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gate-passes-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Print passes
        function printPasses() {
            const printWindow = window.open('', '_blank');
            const table = document.getElementById('passes-table').outerHTML;
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Gate Passes Report</title>
                        <style>
                            body { font-family: 'Poppins', sans-serif; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                        </style>
                    </head>
                    <body>
                        <h1>Gate Passes Report - ${currentUser.name}</h1>
                        <p>Generated on: ${new Date().toLocaleString()}</p>
                        ${table}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Bulk operations
        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('input[type="checkbox"][data-pass-id]');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateBulkActions();
        }

        function updateBulkActions() {
            const selected = document.querySelectorAll('input[type="checkbox"][data-pass-id]:checked');
            const bulkActions = document.getElementById('bulk-actions');
            if (selected.length > 0) {
                bulkActions.classList.add('show');
            } else {
                bulkActions.classList.remove('show');
            }
        }

        function executeBulkAction() {
            const action = document.getElementById('bulk-action').value;
            const selected = document.querySelectorAll('input[type="checkbox"][data-pass-id]:checked');
            
            if (action === 'cancel' && selected.length > 0) {
                if (confirm(`Cancel ${selected.length} selected passes?`)) {
                    // Implement cancel functionality
                    console.log('Canceling passes:', Array.from(selected).map(cb => cb.dataset.passId));
                }
            }
        }

        function clearSelection() {
            document.getElementById('select-all').checked = false;
            document.querySelectorAll('input[type="checkbox"][data-pass-id]').forEach(cb => cb.checked = false);
            document.getElementById('bulk-actions').classList.remove('show');
        }

        // Initialize
        if (checkAuth()) {
            loadPasses();
            updateDashboardStats();
            setInterval(loadPasses, 5000);
            setInterval(updateDashboardStats, 10000);
        }
    </script>
</body>
</html>